<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… | Dandy</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg: #0b0c10;
      --panel: #12121a;
      --muted:#9aa0b2;
      --accent:#f8a5c2;
      --accent-2:#f78fb6;
      --success:#27ae60;
      --danger:#e74c3c;
      --card-radius:16px;
      --gap:1rem;
      --border: rgba(255,255,255,0.07);
      --font-base: 16px;
      --touch: 48px; /* Ø­Ø¬Ù… Ù„Ù…Ø³ Ù…Ø±ÙŠØ­ */
    }

    *{box-sizing:border-box}
    html,body{height:100%;}
    body {
      margin: 0;
      font-family: 'Tajawal', sans-serif;
      background: linear-gradient(180deg,var(--bg) 0%, #07070b 100%);
      color: #fff;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      font-size: var(--font-base);
      line-height:1.5;
    }

    /* Layout */
    .app{
      display:grid;
      grid-template-columns: 300px 1fr;
      gap: calc(var(--gap) + 0.5rem);
      min-height:100vh;
      padding:1rem;
    }

    /* Sidebar */
    .sidebar{
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.06));
      padding: 1.25rem;
      border-radius: calc(var(--card-radius) + 4px);
      box-shadow: 0 12px 30px rgba(0,0,0,0.6);
      color:var(--accent);
      border:1px solid var(--border);
      min-height:220px;
    }

    .brand{display:flex;align-items:center;gap:0.75rem;margin-bottom:1rem}
    .brand i{font-size:1.5rem}
    .brand h2{margin:0;font-size:1.06rem}
    .nav{margin-top:1rem}
    .nav a{display:block;padding:0.85rem;border-radius:10px;color:var(--muted);text-decoration:none;margin-bottom:0.5rem;border:1px solid transparent}
    .nav a.active, .nav a:hover{background:linear-gradient(90deg,var(--accent-2),var(--accent));color:#111;border-color:rgba(255,255,255,0.03)}

    .user-actions{margin-top:1.25rem;display:flex;gap:0.6rem;flex-wrap:wrap}
    .btn{display:inline-block;padding:0.72rem 1rem;border-radius:12px;border:none;cursor:pointer;font-weight:800;font-size:0.98rem;min-height:var(--touch)}
    .btn.primary{background:var(--accent);color:#111}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}

    /* Topbar + Main */
    .main{
      padding:0.8rem 0.4rem;
      display:flex;flex-direction:column;gap:var(--gap)
    }

    .topbar{display:flex;justify-content:space-between;align-items:center;gap:1rem}
    .topbar h1{margin:0;color:var(--accent);font-size:1.35rem}

    /* Cards & forms grid */
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:1rem;
      align-items:start;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.06));
      padding:1.25rem;border-radius:14px;box-shadow:0 8px 22px rgba(0,0,0,0.55);
      border:1px solid var(--border);
    }

    /* Forms: improved spacing & typography */
    form{display:block}
    .form-row{margin-bottom:1rem}
    form label{display:block;margin-bottom:0.5rem;color:var(--muted);font-weight:800;font-size:1.02rem}
    form input, form select, form textarea{width:100%;padding:1rem;border-radius:12px;border:1px solid rgba(255,255,255,0.04);background:#0f1216;color:#fff;font-size:1.02rem}
    form input::placeholder, form textarea::placeholder{color: #8f98a8}
    form textarea{min-height:130px}
    .actions{display:flex;gap:0.75rem;margin-top:0.9rem}
    .actions .btn{flex:1}

    /* Products list */
    .products-panel{display:flex;flex-direction:column;gap:1rem}
    .product-item{display:flex;align-items:center;justify-content:space-between;gap:1rem;padding:1rem;border-radius:12px;border:1px solid var(--border);background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02));}
    .product-left{display:flex;align-items:center;gap:1rem}
    .product-left img{width:96px;height:96px;object-fit:cover;border-radius:12px;border:1px solid rgba(255,255,255,0.04)}
    .product-meta{display:flex;flex-direction:column}
    .product-name{font-weight:900;color:var(--accent);font-size:1.08rem}
    .product-price{color:var(--muted);font-size:1rem}

    .control-group{display:flex;gap:0.6rem;align-items:center}
    .control-group .btn{padding:0.6rem 0.9rem;font-size:0.98rem}

    /* Table styling (improved) */
    #productsTable{width:100%;border-collapse:collapse;background:transparent;margin-top:0.9rem}
    #productsTable th, #productsTable td{padding:14px 14px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.04);font-size:1rem}
    #productsTable thead th{background:linear-gradient(90deg,var(--accent-2),var(--accent));color:#111;font-weight:800}
    #productsTable tr:hover{background:rgba(255,255,255,0.02)}

    .chip{display:inline-block;padding:0.28rem 0.6rem;border-radius:999px;font-size:0.95rem}
    .chip.sale{background:rgba(39,174,96,0.12);color:var(--success)}
    .chip.none{background:rgba(255,255,255,0.03);color:var(--muted)}

    /* Modal (Ù…Ø­Ø³Ù‘Ù†) */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.55);z-index:9999;padding:1rem}
    .modal.show{display:flex}
    .modal .modal-card{background:var(--panel);padding:1rem;border-radius:12px;min-width:320px;border:1px solid var(--border);box-shadow:0 18px 50px rgba(0,0,0,0.65);max-width:720px;width:100%;transform:translateY(12px);opacity:0;transition:transform 220ms cubic-bezier(.2,.9,.2,1),opacity 220ms ease}
    .modal.show .modal-card{transform:translateY(0);opacity:1}
    .modal .modal-card h4{margin:0 0 0.25rem 0;font-size:1.05rem}
    .modal .modal-card p{margin:0;font-size:0.98rem}
    @media (max-width:600px){
      .modal .modal-card{max-width:420px;padding:0.9rem;border-radius:10px}
    }

    /* Toolbar (Ø§Ù„ÙƒØ§Ø±Ø¯ Ø§Ù„Ø°ÙŠ ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ø£Ø²Ø±Ø§Ø±) */
    .toolbar{padding:0.9rem;border-radius:12px;border:1px solid var(--border);background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02));display:flex;justify-content:space-between;align-items:center}

    /* Responsive: mobile-first UX improvements */
    @media (max-width:980px){
      .app{grid-template-columns:1fr;}
      .sidebar{order: -1;display:flex;align-items:center;justify-content:space-between;padding:0.6rem 0.8rem}
      .brand h2{font-size:1rem}
      .nav{display:flex;gap:0.5rem;overflow:auto}
      .nav a{white-space:nowrap;padding:0.55rem 0.85rem;font-size:0.95rem}
      .grid{grid-template-columns:1fr}
    }

    @media (max-width:600px){
      :root{--font-base:15px}
      body{padding-bottom:0.5rem}

      /* make form fields bigger and spaced */
      form label{font-size:1.04rem;margin-bottom:0.6rem}
      form input, form select, form textarea{padding:1.05rem;font-size:1.04rem;border-radius:12px}

      /* stack layout for products to be easy to scan */
      .product-item{flex-direction:column;align-items:stretch;padding:0.95rem}
      .product-left{gap:0.8rem}
      .product-left img{width:84px;height:84px}
      .control-group{width:100%;justify-content:space-between}
      .control-group .btn{flex:1}

      /* table becomes card-like with clear labels */
      #productsTable thead{display:none}
      #productsTable, #productsTable tbody, #productsTable tr, #productsTable td{display:block;width:100%}
      #productsTable tr{margin-bottom:0.9rem;border-radius:12px;padding:0.85rem;border:1px solid rgba(255,255,255,0.04);background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.03))}
      #productsTable td{Padding:10px 12px;position:relative;text-align:right}
      #productsTable td::before{content:attr(data-label);position:absolute;left:12px;top:10px;font-weight:900;color:var(--muted);display:block}
      #productsTable td img{width:56px;height:56px}

      /* buttons full width for easier tapping */
      .actions .btn, .control-group .btn{min-height:var(--touch);padding:0.75rem 1rem}
      .actions{flex-direction:column}
      .actions .btn{width:100%}

      /* sidebar collapse to slim top bar */
      .sidebar{display:flex;flex-direction:row;align-items:center;gap:0.5rem;padding:0.6rem;border-radius:10px}
      .nav{display:none}

      /* keep header compact */
      .topbar h1{font-size:1.05rem}
    }

    /* utility */
    .muted{color:var(--muted)}
    a.link{color:var(--accent);text-decoration:none}

    /* notification */
    .toast{position:fixed;left:50%;transform:translateX(-50%);top:18px;background:var(--accent);color:#111;padding:0.8rem 1.1rem;border-radius:10px;z-index:999}
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar" aria-label="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©">
      <div class="brand"><i class="fa-solid fa-feather fa-lg"></i><h2>Dandy - Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2></div>

      <nav class="nav" aria-label="Ø±ÙˆØ§Ø¨Ø· Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…">
        <a href="#products" class="active"><i class="fa-solid fa-box"></i> Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a>
        <a href="#testimonials"><i class="fa-regular fa-star"></i> Ø¢Ø±Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</a>
        <a href="#articles"><i class="fa-solid fa-pen-nib"></i> Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª</a>
      </nav>

      <div class="user-actions">
        <button id="signOutBtn" class="btn ghost" title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        <button id="goArticles" class="btn primary">ØµÙØ­Ø© Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª</button>
        <button id="statsBtn" class="btn ghost">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
        <button id="ordersBtn" class="btn ghost">ğŸ§¾ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
      </div>

      <hr style="margin:1rem 0;border-color:rgba(255,255,255,0.03)">

      <div>
        <label class="muted">ğŸ”— ØªÙˆÙ„ÙŠØ¯ Ø±Ø§Ø¨Ø· ÙˆØ§ØªØ³Ø§Ø¨ Ø³Ø±ÙŠØ¹</label>
        <div style="display:flex;gap:0.5rem;margin-top:0.5rem">
          <input id="waNumber" placeholder="Ù…Ø«Ø§Ù„: 01012345678" style="flex:1;padding:0.6rem;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:#0f1216;color:#fff"> 
          <button id="waGen" class="btn primary">Ù†Ø³Ø®</button>
        </div>
        <p class="muted" style="font-size:0.85rem;margin-top:0.35rem">Ø³ÙŠØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø© (Ø¥Ù† Ø£Ù…ÙƒÙ†)</p>
      </div>

    </aside>

    <main class="main">
      <div class="topbar">
        <h1>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Dandy</h1>
        <div style="display:flex;gap:0.75rem;align-items:center">
          <div class="muted">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: <strong id="adminName">Ù…Ø¯ÙŠØ±</strong></div>
        </div>
      </div>

      <section class="grid">
        <!-- Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ -->
        <div class="card" id="products">
          <h3 style="color:var(--accent);margin-top:0">Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†ØªØ¬</h3>
          <form id="productForm">
            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
            <input type="text" id="name" required placeholder="Ø³ÙŠØ±ÙˆÙ…...">

            <label>Ø§Ù„ÙØ¦Ø©</label>
            <select id="category" required>
              <option value="Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø´Ø¹Ø±">Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø´Ø¹Ø±</option>
              <option value="Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¬Ø³Ù…">Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¬Ø³Ù…</option>
              <option value="Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¹Ø·ÙˆØ±">Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¹Ø·ÙˆØ±</option>
            </select>

            <label>Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© <a href="https://postimages.org/" target="_blank" class="link">ğŸ”— Ø±ÙØ¹ ØµÙˆØ±Ø©</a></label>
            <input type="url" id="image" placeholder="https://..." required>

            <label>Ø§Ù„ÙˆØµÙ</label>
            <textarea id="description" placeholder="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬"></textarea>

            <label>Ø§Ù„Ø³Ø¹Ø± (Ø¨Ø¯ÙˆÙ† Ø±Ù…ÙˆØ²)</label>
            <input type="text" id="price" placeholder="Ù…Ø«Ø§Ù„: 250" required>

            <label>Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªÙˆØ§ØµÙ„</label>
            <input type="url" id="whatsapp" placeholder="https://wa.me/...">
            <input type="url" id="facebook" placeholder="Ø±Ø§Ø¨Ø· ÙÙŠØ³Ø¨ÙˆÙƒ">
            <input type="url" id="instagram" placeholder="Ø±Ø§Ø¨Ø· Ø¥Ù†Ø³ØªØ¬Ø±Ø§Ù…">

            <div class="actions">
              <button class="btn primary" type="submit">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬</button>
              <button id="resetForm" type="button" class="btn ghost">ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
            </div>
          </form>

          <!-- toolbar Ù…Ø­Ø³Ù† -->
          <div class="toolbar" style="margin-top:1rem;">
            <div style="display:flex;align-items:center;gap:0.6rem">
              <strong class="muted">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</strong>
              <span class="muted" style="font-size:0.95rem">(Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="productsCount">0</span>)</span>
            </div>
            <div style="display:flex;gap:0.6rem;flex-wrap:wrap">
              <button id="downloadExcel" class="btn ghost" title="ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Excel">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Excel</button>
              <button id="refreshProducts" class="btn ghost" title="ØªØ­Ø¯ÙŠØ«">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
            </div>
          </div>

          <div class="products-panel" id="productsList" style="margin-top:0.8rem"></div>

        </div>

        <!-- Ø¬Ø¯ÙˆÙ„ ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶ -->
        <div class="card">
          <h3 style="color:var(--accent);margin-top:0">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶</h3>

          <div style="overflow:auto;margin-top:0.6rem">
            <table id="productsTable" aria-describedby="Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª">
              <thead>
                <tr>
                  <th>Ø§Ù„ØµÙˆØ±Ø©</th>
                  <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
                  <th>Ø§Ù„Ø³Ø¹Ø±</th>
                  <th>Ø§Ù„Ù‚Ø³Ù…</th>
                  <th>Ø§Ù„Ø®ØµÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ</th>
                  <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

        </div>
      </section>

      <!-- Testimonials -->
      <section class="card" id="testimonials">
        <h3 style="color:var(--accent);margin-top:0">Ø¢Ø±Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h3>
        <form id="testimonialForm" style="margin-top:0.6rem;display:flex;gap:0.6rem;flex-direction:column">
          <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰</label>
          <select id="testimonialType"><option value="image">ØµÙˆØ±Ø©</option><option value="video">ÙÙŠØ¯ÙŠÙˆ</option></select>
          <label>Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø­ØªÙˆÙ‰</label>
          <input id="testimonialUrl" type="url" placeholder="https://...">
          <div style="display:flex;gap:0.5rem">
            <button class="btn primary" type="submit">Ø¥Ø¶Ø§ÙØ© Ø±Ø£ÙŠ</button>
            <button id="clearTestimonials" type="button" class="btn ghost">ØªÙØ±ÙŠØº</button>
          </div>
        </form>

        <div class="products-panel" id="testimonialList" style="margin-top:1rem"></div>
      </section>

      <!-- Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… + Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª -->
      <section class="card" id="articles" style="margin-bottom:2rem">
        <h3 style="color:var(--accent);margin-top:0">ğŸ“˜ Ø¯Ù„ÙŠÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø³Ø±ÙŠØ¹</h3>
        <ul class="muted" style="line-height:1.8;margin:0.6rem 0;padding-inline-start:1rem">
          <li>Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ ÙˆØ§Ù„Ø³Ø¹Ø± (Ø§Ù„Ø³Ø¹Ø± Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·).</li>
          <li>Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù…Ø¨Ø§Ø´Ø±Ù‹Ø§ (https).</li>
          <li>Ø²Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙŠÙØµØ¯Ø± Ù…Ù„Ù Excel ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ØŒ Ø§Ù„ÙØ¦Ø© ÙˆØ§Ù„Ø³Ø¹Ø±.</li>
        </ul>

        <div style="margin-top:0.6rem;text-align:center">
          <button id="openArticles" class="btn primary">Ø§Ø°Ù‡Ø¨ Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª</button>
        </div>
      </section>

      <!-- Modal Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø®ØµÙ… (Ù…Ø­Ø³Ù‘Ù†) -->
      <div id="discountModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true" tabindex="-1">
        <div class="modal-card" role="document" aria-labelledby="discountTitle">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:0.6rem;margin-bottom:0.6rem">
            <h4 id="discountTitle" style="margin:0;color:var(--accent)">ØªØ¹ÙŠÙŠÙ† Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ…</h4>
            <button id="modalCloseX" class="btn ghost" aria-label="Ø¥ØºÙ„Ø§Ù‚">âœ–</button>
          </div>
          <p class="muted">Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ… Ø¨ÙŠÙ† 1 Ùˆ 90 (Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·)</p>
          <input id="discountInput" type="number" min="1" max="90" placeholder="Ù…Ø«Ø§Ù„: 20" style="margin-top:0.6rem">
          <div style="display:flex;gap:0.6rem;margin-top:0.8rem;justify-content:flex-end">
            <button id="applyDiscount" class="btn primary">ØªØ·Ø¨ÙŠÙ‚</button>
            <button id="closeModal" class="btn ghost">Ø¥Ù„ØºØ§Ø¡</button>
          </div>
        </div>
      </div>

      <div id="toastHolder"></div>

    </main>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <script>
    // --- Ø¥Ø¹Ø¯Ø§Ø¯ Firebase --- (Ø§Ø­ØªÙØ¸Øª Ø¨Ø¨ÙŠØ§Ù†Ø§ØªÙƒ ÙƒÙ…Ø§ Ù‡ÙŠ)
    const firebaseConfig = {
      apiKey: "AIzaSyDqYY4EF0Nig9aBOxmWZJA8D-4Gr4tT-UU",
      authDomain: "dandy-562fc.firebaseapp.com",
      databaseURL: "https://dandy-562fc-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "dandy-562fc",
      storageBucket: "dandy-562fc.appspot.com",
      messagingSenderId: "454972972842",
      appId: "1:454972972842:web:fedc5e92e258a06ca08853"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Ø¹Ù†Ø§ØµØ± UI
    const productForm = document.getElementById('productForm');
    const productsList = document.getElementById('productsList');
    const productsTableBody = document.querySelector('#productsTable tbody');
    const testimonialForm = document.getElementById('testimonialForm');
    const testimonialList = document.getElementById('testimonialList');
    const downloadExcelBtn = document.getElementById('downloadExcel');
    const refreshBtn = document.getElementById('refreshProducts');
    const waGenBtn = document.getElementById('waGen');
    const waNumberInput = document.getElementById('waNumber');

    // modal
    const discountModal = document.getElementById('discountModal');
    const discountInput = document.getElementById('discountInput');
    const applyDiscountBtn = document.getElementById('applyDiscount');
    const closeModalBtn = document.getElementById('closeModal');
    let currentDiscountProductId = null;

    // Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
    function toast(msg, time=2500){
      const t = document.createElement('div');
      t.className='toast'; t.innerText = msg;
      document.getElementById('toastHolder').appendChild(t);
      setTimeout(()=>t.remove(), time);
    }

    function safeNumber(value){
      // ØªØ±Ø¬Ø¹ null Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø±Ù‚Ù… ØµØ­ÙŠØ­
      const n = Number(String(value).replace(/[^0-9.]/g,''));
      return isFinite(n) && n!=='' ? n : null;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø©)
    firebase.auth().onAuthStateChanged(user => {
      if (!user) {
        window.location.href = 'login.html';
      } else {
        document.getElementById('adminName').innerText = user.displayName || (user.email || 'Ù…Ø¯ÙŠØ±');
      }
    });

    // Ø¥Ø¶Ø§ÙØ© / ØªØ­Ø¯ÙŠØ« Ù…Ù†ØªØ¬
    productForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      const name = document.getElementById('name').value.trim();
      const category = document.getElementById('category').value;
      const image = document.getElementById('image').value.trim();
      const description = document.getElementById('description').value.trim();
      const priceRaw = document.getElementById('price').value.trim();
      const whatsapp = document.getElementById('whatsapp').value.trim();
      const facebook = document.getElementById('facebook').value.trim();
      const instagram = document.getElementById('instagram').value.trim();

      const price = safeNumber(priceRaw);
      if (price === null) return toast('âš ï¸ Ø§Ù„Ø³Ø¹Ø± ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø±Ù‚Ù…Ù‹Ø§ ØµØ§Ù„Ø­Ù‹Ø§');

      const newProductRef = db.ref('products').push();
      newProductRef.set({
        name, category, image, description, price, whatsapp, facebook, instagram,
        onSale:false, discount:null, createdAt: Date.now()
      }).then(()=>{
        toast('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬');
        productForm.reset();
      }).catch(err=>{
        console.error(err); toast('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸');
      });
    });

    document.getElementById('resetForm').addEventListener('click',()=>productForm.reset());

    // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (Ù‚Ø§Ø¦Ù…Ø© ÙˆØ¨Ø¬Ø¯ÙˆÙ„)
    function renderProducts(snapshot){
      productsList.innerHTML='';
      productsTableBody.innerHTML='';

      snapshot.forEach(child => {
        const id = child.key; const data = child.val();

        // Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø³ÙŠØ·Ø©
        const item = document.createElement('div'); item.className='product-item';
        item.innerHTML = `
          <div class="product-left">
            <img src="${data.image || ''}" alt="${data.name}" onerror="this.onerror=null;this.src='https://via.placeholder.com/150?text=No+Image'">
            <div class="product-meta">
              <div class="product-name">${data.name}</div>
              <div class="product-price">${data.price} EGP Â· ${data.category}</div>
            </div>
          </div>
          <div style="display:flex;gap:0.5rem;align-items:center">
            <button class="btn ghost" data-action="edit" data-id="${id}">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="btn" data-action="delete" data-id="${id}" style="background:${'--'};border:1px solid rgba(255,255,255,0.03)">ğŸ—‘ï¸ Ø­Ø°Ù</button>
          </div>
        `;
        productsList.appendChild(item);

        // ØµÙ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td data-label="Ø§Ù„ØµÙˆØ±Ø©"><img src="${data.image || ''}" style="width:50px;height:50px;object-fit:cover;border-radius:6px" onerror="this.onerror=null;this.src='https://via.placeholder.com/80?text=No'"/></td>
          <td data-label="Ø§Ù„Ø§Ø³Ù…">${data.name}</td>
          <td data-label="Ø§Ù„Ø³Ø¹Ø±">${data.price} EGP</td>
          <td data-label="Ø§Ù„Ù‚Ø³Ù…">${data.category}</td>
          <td data-label="Ø§Ù„Ø®ØµÙ…">${data.onSale ? `<span class='chip sale'>Ø®ØµÙ… ${data.discount}%</span>` : `<span class='chip none'>Ù„Ø§ ÙŠÙˆØ¬Ø¯</span>`}</td>
          <td data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª">
            <div style="display:flex;gap:0.4rem;justify-content:center">
              <button class="btn ghost" data-action="discount" data-id="${id}">ğŸ¯</button>
              <button class="btn ghost" data-action="removeOffer" data-id="${id}">âŒ</button>
            </div>
          </td>
        `;
        productsTableBody.appendChild(tr);
      });

    }

    // Ù…Ø³ØªÙ…Ø¹ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù…Ù†ØªØ¬Ø§Øª - ÙŠØ­Ø¯Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø£ÙŠ ØªØºÙŠÙŠØ±
    db.ref('products').on('value', snapshot => {
      if (!snapshot.exists()){
        productsList.innerHTML='<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</div>';
        productsTableBody.innerHTML='';
        const countEl = document.getElementById('productsCount'); if(countEl) countEl.innerText = 0;
        return;
      }
      renderProducts(snapshot);
      const countEl = document.getElementById('productsCount'); if (countEl) countEl.innerText = snapshot.numChildren();
    });

    // ØªÙÙˆÙŠØ¶ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« (Ø­Ø°ÙØŒ ØªØ¹Ø¯ÙŠÙ„ØŒ ØªØ¹ÙŠÙŠÙ† Ø®ØµÙ…)
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-action]');
      if (!btn) return;
      const action = btn.dataset.action; const id = btn.dataset.id;

      if (action === 'delete'){
        if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ØŸ')){
          db.ref('products').child(id).remove().then(()=>toast('ğŸ—‘ï¸ ØªÙ… Ø§Ù„Ø­Ø°Ù'));
        }
      }

      if (action === 'edit'){
        // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù…Ù„Ø£ Ø§Ù„Ø­Ù‚ÙˆÙ„ (ØªØ­ÙˆÙŠÙ„ ÙˆØ§Ø¬Ù‡Ø© Ø¥Ù„Ù‰ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„)
        db.ref('products/'+id).once('value').then(snap => {
          const data = snap.val();
          if (!data) return toast('âŒ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
          document.getElementById('name').value = data.name || '';
          document.getElementById('category').value = data.category || '';
          document.getElementById('image').value = data.image || '';
          document.getElementById('description').value = data.description || '';
          document.getElementById('price').value = data.price || '';
          document.getElementById('whatsapp').value = data.whatsapp || '';
          document.getElementById('facebook').value = data.facebook || '';
          document.getElementById('instagram').value = data.instagram || '';

          // Ø¨Ø¯Ù„ Ø£Ù† Ù†Ø¶ÙŠÙØŒ Ø³Ù†Ù‚ÙˆÙ… Ø¨ØªØ­Ø¯ÙŠØ« Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…Ø¹Ø±Ù ØªØ¹Ø¯ÙŠÙ„
          productForm.dataset.editing = id;
          toast('ğŸ“ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø«Ù… Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬" Ù„Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª (Ø³ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«)');
        });
      }

      if (action === 'discount'){
        // ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ù…Ø­Ø³Ù‘Ù†Ø©
        currentDiscountProductId = id; discountInput.value = '';
        discountModal.setAttribute('aria-hidden','false');
        discountModal.classList.add('show');
        setTimeout(()=>{
          discountInput.focus();
        },80);
      }

      if (action === 'removeOffer'){
        db.ref('products/'+id).update({onSale:false, discount:null}).then(()=>toast('âŒ ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ø§Ù„Ø¹Ø±ÙˆØ¶'));
      }
    });

    // Ø¹Ù†Ø¯ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙÙŠ ÙˆØ¶Ø¹ ØªØ¹Ø¯ÙŠÙ„
    productForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const editingId = productForm.dataset.editing;
      if (!editingId) return; // handled ÙÙŠ Ø¥Ø¶Ø§ÙØ©

      const updates = {
        name: document.getElementById('name').value.trim(),
        category: document.getElementById('category').value,
        image: document.getElementById('image').value.trim(),
        description: document.getElementById('description').value.trim(),
        price: safeNumber(document.getElementById('price').value),
        whatsapp: document.getElementById('whatsapp').value.trim(),
        facebook: document.getElementById('facebook').value.trim(),
        instagram: document.getElementById('instagram').value.trim(),
      };

      if (updates.price === null){ toast('âš ï¸ Ø§Ù„Ø³Ø¹Ø± ØºÙŠØ± ØµØ§Ù„Ø­'); return; }

      db.ref('products/'+editingId).update(updates).then(()=>{
        toast('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬');
        delete productForm.dataset.editing;
        productForm.reset();
      }).catch(()=>toast('âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«'));
    });

    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®ØµÙ…
    applyDiscountBtn.addEventListener('click', ()=>{
      const val = Number(discountInput.value);
      if (!currentDiscountProductId) return;
      if (!Number.isInteger(val) || val < 1 || val > 90){ toast('âš ï¸ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­ Ø¨ÙŠÙ† 1 Ùˆ 90'); return; }
      db.ref('products/'+currentDiscountProductId).update({onSale:true,discount:val}).then(()=>{
        toast('âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø®ØµÙ…');
        discountModal.classList.remove('show');
        discountModal.setAttribute('aria-hidden','true');
        currentDiscountProductId = null;
      }).catch(()=>toast('âŒ ÙØ´Ù„ ÙÙŠ ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø®ØµÙ…'));
    });

    closeModalBtn.addEventListener('click', ()=>{ discountModal.classList.remove('show'); discountModal.setAttribute('aria-hidden','true'); currentDiscountProductId=null; });

    // Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
    discountModal.addEventListener('click', (ev)=>{ if (ev.target === discountModal){ discountModal.classList.remove('show'); discountModal.setAttribute('aria-hidden','true'); currentDiscountProductId=null; } });
    // Ø²Ø± Ø¥ØºÙ„Ø§Ù‚ X
    const modalX = document.getElementById('modalCloseX'); if (modalX) modalX.addEventListener('click', ()=>{ discountModal.classList.remove('show'); discountModal.setAttribute('aria-hidden','true'); currentDiscountProductId=null; });
    // Ø¥ØºÙ„Ø§Ù‚ Ø¨Ø²Ø± Esc
    document.addEventListener('keydown', (ev)=>{ if (ev.key === 'Escape' && discountModal.classList.contains('show')){ discountModal.classList.remove('show'); discountModal.setAttribute('aria-hidden','true'); currentDiscountProductId=null; } });

    // ===== Testimonials =====
    testimonialForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      const type = document.getElementById('testimonialType').value;
      const url = document.getElementById('testimonialUrl').value.trim();
      if (!url){ toast('âš ï¸ Ø£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø­ØªÙˆÙ‰'); return; }
      const newRef = db.ref('testimonials').push();
      newRef.set({type,url}).then(()=>{ toast('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø±Ø£ÙŠ'); testimonialForm.reset(); });
    });

    document.getElementById('clearTestimonials').addEventListener('click', ()=>{
      if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªÙØ±ÙŠØº Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¢Ø±Ø§Ø¡ØŸ')){
        db.ref('testimonials').remove().then(()=>toast('ğŸ—‘ï¸ ØªÙ… Ø§Ù„ØªÙØ±ÙŠØº'));
      }
    });

    db.ref('testimonials').on('value', snapshot => {
      testimonialList.innerHTML='';
      if (!snapshot.exists()) return testimonialList.innerHTML='<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¢Ø±Ø§Ø¡ Ø¨Ø¹Ø¯</div>';
      snapshot.forEach(child=>{
        const {type,url} = child.val(); const id = child.key;
        const div = document.createElement('div'); div.className='product-item';
        div.innerHTML = `
          <div class="product-left">
            ${type==='image'? `<img src="${url}" alt="testimonial" onerror="this.onerror=null;this.src='https://via.placeholder.com/80'">` : `<video src="${url}" width="80" muted></video>`}
            <div class="product-meta"><div class="product-name">${type==='image' ? 'ØµÙˆØ±Ø©' : 'ÙÙŠØ¯ÙŠÙˆ'}</div><div class="product-price muted">${url}</div></div>
          </div>
          <div style="display:flex;gap:0.5rem"><button class="btn ghost" data-action="deleteTestimonial" data-id="${id}">Ø­Ø°Ù</button></div>
        `;
        testimonialList.appendChild(div);
      });
    });

    // Ø­Ø°Ù Ø¢Ø±Ø§Ø¡ Ø¨ÙˆØ§Ø³Ø·Ø© ØªÙÙˆÙŠØ¶
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-action="deleteTestimonial"]');
      if (!btn) return;
      const id = btn.dataset.id;
      if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø±Ø£ÙŠØŸ')){
        db.ref('testimonials').child(id).remove().then(()=>toast('ğŸ—‘ï¸ ØªÙ… Ø§Ù„Ø­Ø°Ù'));
      }
    });

    // ØªÙ†Ø²ÙŠÙ„ Excel
    downloadExcelBtn.addEventListener('click', ()=>{
      db.ref('products').once('value').then(snapshot=>{
        const arr = [];
        snapshot.forEach(child=>{ const p = child.val(); arr.push({"Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬":p.name, "Ø§Ù„ÙØ¦Ø©":p.category, "Ø§Ù„Ø³Ø¹Ø±":p.price})});
        const ws = XLSX.utils.json_to_sheet(arr);
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª');
        XLSX.writeFile(wb,'Ù…Ù†ØªØ¬Ø§Øª_Dandy.xlsx');
      });
    });

    refreshBtn.addEventListener('click', ()=>{ toast('âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«'); /* listener already keeps it live */ });

    // ØªÙˆÙ„ÙŠØ¯ Ø±Ø§Ø¨Ø· ÙˆØ§ØªØ³Ø§Ø¨
    waGenBtn.addEventListener('click', ()=>{
      let num = waNumberInput.value.replace(/\D/g,'');
      if (!num) return toast('âš ï¸ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù…Ù‹Ø§');
      // if starts with 0 -> assume Egyptian local number and convert to +2
      if (num.startsWith('0')) num = '2'+num;
      if (!num.startsWith('2')) num = num; // allow international
      const link = `https://wa.me/${num}`;
      navigator.clipboard.writeText(link).then(()=>{ toast('âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·'); document.getElementById('whatsapp').value = link; }).catch(()=>{ toast('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø§Ø¨Ø· (Ø§Ù†Ø³Ø®Ù‡ ÙŠØ¯ÙˆÙŠØ§Ù‹)'); document.getElementById('whatsapp').value = link; });
    });

    // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ØµÙØ­Ø§Øª Ø£Ø®Ø±Ù‰
    document.getElementById('goArticles').addEventListener('click', ()=> window.location.href='dashboard-blog.html');
    document.getElementById('openArticles').addEventListener('click', ()=> window.location.href='dashboard-blog.html');
    document.getElementById('statsBtn').addEventListener('click', ()=> window.location.href='statues.html');
    document.getElementById('ordersBtn').addEventListener('click', ()=> window.location.href='dashboard-order.html');

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
    document.getElementById('signOutBtn').addEventListener('click', ()=>{
      firebase.auth().signOut().then(()=>{ window.location.href='login.html'; });
    });

  </script>
</body>
</html>
