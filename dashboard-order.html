<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>لوحة تحكم الطلبات | Dandy</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root{
  --bg:#f5f7fa;
  --panel:#ffffff;
  --text:#1e293b;
  --muted:#64748b;
  --accent:#3b82f6;
  --success:#10b981;
  --warning:#f59e0b;
  --danger:#ef4444;
  --border:#e2e8f0;
  --shadow: rgba(0,0,0,0.1);
}
*{box-sizing:border-box;}
html,body{height:100%;margin:0;font-family:'Tajawal',sans-serif;background:var(--bg);color:var(--text);}
.container{max-width:1400px;margin:0 auto;padding:2rem;display:flex;flex-direction:column;gap:2rem;}
header{display:flex;flex-direction:column;gap:1.5rem;}
.header-top{display:flex;align-items:center;justify-content:space-between;gap:1rem;}
h1{font-size:2rem;margin:0;color:var(--accent);display:flex;align-items:center;gap:0.7rem;}
h1 .logo{display:flex;align-items:center;justify-content:center;width:60px;height:60px;border-radius:12px;background:var(--accent);color:white;font-weight:700;font-size:1.3rem;box-shadow:0 4px 12px var(--shadow);}
.controls{display:flex;gap:1rem;flex-wrap:wrap;align-items:center;}
.search-wrapper{flex:1;display:flex;align-items:center;gap:0.5rem;background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:0.7rem 0.8rem;transition:all 0.2s;}
.search-wrapper:hover{border-color:var(--accent);}
.search-wrapper input{flex:1;border:none;background:transparent;font-size:1rem;color:var(--text);outline:none;}
.select-wrap select{padding:0.6rem 0.9rem;border-radius:12px;border:1px solid var(--border);background:var(--panel);font-size:1rem;color:var(--text);}
.stats{display:flex;gap:1.2rem;flex-wrap:wrap;}
.stat{background:var(--panel);padding:0.6rem 0.9rem;border-radius:12px;border:1px solid var(--border);font-size:1rem;display:flex;align-items:center;gap:0.5rem;box-shadow:0 2px 8px var(--shadow);}
.stat strong{color:var(--text);}
.card{background:var(--panel);border-radius:18px;padding:1.2rem;box-shadow:0 10px 28px var(--shadow);overflow-x:auto;}
table{width:100%;border-collapse:separate;border-spacing:0 0.8rem;}
thead th{padding:1rem 1.2rem;font-weight:700;color:var(--muted);border-bottom:2px solid var(--border);text-align:center;}
tbody tr{background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:0 4px 12px var(--shadow);}
td{padding:1rem 1.2rem;text-align:center;font-size:1rem;vertical-align:middle;}
tbody tr:hover{background:#f9fafb;}
.badge{padding:0.4rem 0.9rem;border-radius:999px;font-weight:600;font-size:0.85rem;display:inline-block;}
.badge.new{background:#d1fae5;color:var(--success);}
.badge.contact{background:#fef3c7;color:var(--warning);}
.badge.done{background:#e2e8f0;color:var(--muted);}
.actions button{margin:0 3px;padding:0.55rem 1rem;border:none;border-radius:10px;cursor:pointer;font-size:0.9rem;transition:all 0.2s;font-weight:600;}
.actions button:hover{transform:translateY(-2px);}
.btn-delete{background:#fee2e2;color:var(--danger);}
.empty{padding:1.2rem;text-align:center;color:var(--muted);font-size:1rem;}
.product-list{display:flex;flex-direction:column;gap:0.4rem;}
.product-item{background:#f8fafc;border:1px solid var(--border);padding:0.5rem 0.8rem;border-radius:10px;font-size:0.9rem;text-align:right;}
@media(max-width:768px){
  .header-top{flex-direction:column;align-items:flex-start;}
  .controls{flex-direction:column;align-items:stretch;}
  table,thead,tbody,tr,td{display:block;width:100%;}
  thead{display:none;}
  td{padding:0.9rem 1rem;text-align:right;border-bottom:1px solid var(--border);}
  td::before{content:attr(data-label);display:block;font-weight:600;color:var(--muted);margin-bottom:0.3rem;}
  tbody tr{margin-bottom:1rem;background:var(--panel);border-radius:14px;box-shadow:0 6px 16px var(--shadow);}
  .actions button,.btn-delete{width:100%;margin:0.3rem 0;}
  td[data-label="المنتج"] .product-list{margin-top:0.5rem;}
}
</style>
</head>
<body>
<div class="container">
<header>
  <div class="header-top">
    <h1><span class="logo">D</span> لوحة تحكم الطلبات</h1>
    <div class="stats">
      <div class="stat">إجمالي: <strong id="total-count">0</strong></div>
      <div class="stat">جدد: <strong id="count-new">0</strong></div>
      <div class="stat">تواصل: <strong id="count-contact">0</strong></div>
      <div class="stat">مكتمل: <strong id="count-done">0</strong></div>
    </div>
  </div>
  <div class="controls">
    <div class="search-wrapper">
      <i class="fa fa-magnifying-glass"></i>
      <input id="search-orders" type="text" placeholder="ابحث بالاسم، الهاتف، المنتج أو كود الفاتورة">
    </div>
    <div class="select-wrap">
      <select id="filter-status">
        <option value="">عرض كل الحالات</option>
        <option value="جديد">جديد</option>
        <option value="تم التواصل">تم التواصل</option>
        <option value="مكتمل">مكتمل</option>
      </select>
    </div>
  </div>
</header>

<section class="card">
  <table aria-live="polite">
    <thead>
      <tr>
        <th>كود الفاتورة</th>
        <th>العميل</th>
        <th>الهاتف</th>
        <th>الإيميل</th>
        <th>العنوان</th>
        <th>المحافظة</th>
        <th>المدينة</th>
        <th>الدولة</th>
        <th>المنتج</th>
        <th>التاريخ</th>
        <th>الحالة</th>
        <th>تحديث الحالة</th>
        <th>حذف</th>
      </tr>
    </thead>
    <tbody id="orders-table"></tbody>
  </table>
  <div id="empty" class="empty" style="display:none">لا توجد طلبات لعرضها الآن.</div>
</section>
</div>

  <script>
// التحقق من مصدر الدخول للصفحة
if (document.referrer.indexOf("dashboard.html") === -1) {
  // لو اللي جاي مش من dashboard.html → رجعه للداشبورد
  window.location.href = "dashboard.html";
}
</script>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyDqYY4EF0Nig9aBOxmWZJA8D-4Gr4tT-UU",
  authDomain: "dandy-562fc.firebaseapp.com",
  databaseURL: "https://dandy-562fc-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "dandy-562fc",
  storageBucket: "dandy-562fc.appspot.com",
  messagingSenderId: "454972972842",
  appId: "1:454972972842:web:fedc5e92e258a06ca08853"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const tableBody = document.getElementById("orders-table");
const searchInput = document.getElementById("search-orders");
const filterSelect = document.getElementById("filter-status");
const emptyState = document.getElementById('empty');
const totalCount = document.getElementById('total-count');
const countNew = document.getElementById('count-new');
const countContact = document.getElementById('count-contact');
const countDone = document.getElementById('count-done');

function esc(text){ return text == null ? '' : String(text); }

  
function renderOrderRow(key, order){
  const dateTime = order.date || new Date(order.timestamp || Date.now()).toLocaleString('ar-EG');
  const status = (order.status || 'جديد');
  const statusClass = status === 'مكتمل' ? 'done' : (status === 'تم التواصل' ? 'contact' : 'new');

  let productsHTML = '';
  if(order.products && order.products.length){
    productsHTML = '<table style="width:100%;border-collapse:collapse;color:var(--text)">';
    productsHTML += '<tr style="background:rgba(255,255,255,0.02);font-weight:600"><td>المنتج</td><td>الكمية</td><td>السعر</td></tr>';
    order.products.forEach(p=>{
      let priceNum = parseFloat(String(p.price||'').replace(/[^0-9.-]+/g,""))||0;
      let displayPrice = priceNum.toFixed(2)+' EGP';
      if(p.onSale && p.offer){
        const discount = priceNum * parseFloat(p.offer)/100;
        const finalPrice = priceNum - discount;
        displayPrice = `${priceNum.toFixed(2)} EGP - خصم ${p.offer}% = ${finalPrice.toFixed(2)} EGP`;
      }
      productsHTML += `<tr><td>${esc(p.name)}</td><td>${esc(p.quantity||1)}</td><td>${esc(displayPrice)}</td></tr>`;
    });
    productsHTML += '</table>';
  }else{ productsHTML='-'; }

  const tr=document.createElement('tr');
  tr.innerHTML=`<td data-label="كود الفاتورة">${esc(order.invoiceCode||key)}</td>
  <td data-label="العميل">${esc(order.name||'-')}</td>
  <td data-label="الهاتف">${esc(order.phone||'-')}</td>
  <td data-label="الإيميل">${esc(order.email||'-')}</td>
  <td data-label="العنوان">${esc(order.address||'-')}</td>
  <td data-label="المحافظة">${esc(order.governorate||'-')}</td>
  <td data-label="المدينة">${esc(order.city||'-')}</td>
  <td data-label="الدولة">${esc(order.country||'-')}</td>
  <td data-label="المنتج">${productsHTML}</td>
  <td data-label="التاريخ">${esc(dateTime)}</td>
  <td class="status" data-label="الحالة"><span id="status-${key}" class="badge ${statusClass}">${esc(status)}</span></td>
  <td data-label="تحديث الحالة" class="actions">
    <button onclick="updateStatus('${key}','جديد')">جديد</button>
    <button onclick="updateStatus('${key}','تم التواصل')">تم التواصل</button>
    <button onclick="updateStatus('${key}','مكتمل')">مكتمل</button>
  </td>
  <td data-label="حذف"><button class="btn-delete" onclick="deleteOrder('${key}')"><i class="fa fa-trash"></i></button></td>`;
  return tr;
}

let ordersStore={};
db.ref('orders').on('value', snapshot=>{
  ordersStore={};
  snapshot.forEach(child=>{ordersStore[child.key]=child.val();});
  refreshTable();
});

function refreshTable(){
  tableBody.innerHTML='';
  const keys=Object.keys(ordersStore);
  if(!keys.length){emptyState.style.display='block';tableBody.parentElement.style.display='none';updateCounts();return;}
  emptyState.style.display='none';tableBody.parentElement.style.display='';
  keys.forEach(k=>tableBody.appendChild(renderOrderRow(k,ordersStore[k])));
  applyFilters();
  updateCounts();
}

function updateStatus(orderId,status){
  db.ref('orders/'+orderId).update({status})
  .then(()=>{
    const el=document.getElementById(`status-${orderId}`);
    if(el){el.textContent=status;el.className='badge '+(status==='مكتمل'?'done':(status==='تم التواصل'?'contact':'new'));}
    if(ordersStore[orderId]) ordersStore[orderId].status=status;
    updateCounts();
  }).catch(err=>console.error(err));
}

function deleteOrder(orderId){
  if(confirm('هل أنت متأكد من حذف هذا الطلب؟')){
    db.ref('orders/'+orderId).remove().catch(err=>console.error(err));
  }
}

function applyFilters(){
  const searchText=searchInput.value.trim().toLowerCase();
  const statusFilter=filterSelect.value.trim().toLowerCase();
  const rows=tableBody.querySelectorAll('tr');
  rows.forEach(row=>{
    const rowText=row.textContent.toLowerCase();
    const statusEl=row.querySelector('[id^="status-"]');
    const rowStatus=statusEl?statusEl.textContent.toLowerCase():'';
    const matchesSearch=!searchText||rowText.includes(searchText);
    const matchesStatus=!statusFilter||rowStatus===statusFilter;
    row.style.display=(matchesSearch&&matchesStatus)?'':'none';
  });
  updateCounts();
}

function updateCounts(){
  const all=Object.keys(ordersStore).length;
  let nNew=0,nContact=0,nDone=0;
  Object.values(ordersStore).forEach(o=>{
    const s=o.status||'جديد';
    if(s==='جديد') nNew++; else if(s==='تم التواصل') nContact++; else if(s==='مكتمل') nDone++;
  });
  totalCount.textContent=all; countNew.textContent=nNew; countContact.textContent=nContact; countDone.textContent=nDone;
}

let searchTimeout=null;
searchInput.addEventListener('input',()=>{clearTimeout(searchTimeout);searchTimeout=setTimeout(applyFilters,260);});
filterSelect.addEventListener('change',applyFilters);
</script>
</body>
</html>




