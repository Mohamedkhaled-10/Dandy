<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ملفي الشخصي - Dandy</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="style.css">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      display: flex;
      flex-direction: column;
    }
    body {
      flex: 1;
      font-family: 'Tajawal', sans-serif;
    }
    main {
      flex: 1;
      padding: 2rem 1rem;
      max-width: 900px;
      margin: auto;
      width: 100%;
    }
    body.dark-mode {
      background-color: #121212;
      color: #f49ac1;
    }
    .dark-mode .section,
    .dark-mode .user-info,
    .dark-mode .product-card {
      background-color: #1e1e1e;
      color: #f49ac1;
    }
    .user-info {
      background-color: #fff0f6;
      border-radius: 15px;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      margin-bottom: 2rem;
    }
    .user-info .avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background-color: #f49ac1;
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 2.5rem;
      margin-bottom: 1rem;
    }
    .user-info h2 {
      margin: 0;
      font-size: 1.6rem;
    }
    .user-info p {
      margin: 0.3rem 0;
      font-size: 1rem;
    }
    .logout-btn {
      background-color: #f49ac1;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 10px;
      font-size: 1rem;
      margin-top: 1rem;
      cursor: pointer;
      transition: background 0.3s;
    }
    .logout-btn:hover {
      background-color: #e07aa2;
    }
    .section {
      background-color: #fff0f6;
      border-radius: 15px;
      padding: 1rem 1.5rem;
      margin-bottom: 2rem;
    }
    .section h3 {
      font-size: 1.4rem;
      color: var(--accent-color);
      margin-bottom: 1rem;
      text-align: center;
    }
    .cards-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
    }
    .product-card {
      background-color: #fff;
      border-radius: 12px;
      padding: 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      text-align: center;
    }
    .product-card img {
      width: 100%;
      height: 150px;
      object-fit: cover;
      border-radius: 10px;
    }
    .product-card h4 {
      margin: 0.5rem 0;
    }
    .product-card a {
      display: inline-block;
      background-color: var(--accent-color);
      color: white;
      text-decoration: none;
      padding: 0.4rem 1rem;
      border-radius: 20px;
      transition: background 0.3s;
    }
    .product-card a:hover {
      background-color: #e07aa2;
    }
    footer {
      background-color: var(--primary-color);
      text-align: center;
      padding: 2rem;
    }
    .dark-mode footer {
      background-color: #1e1e1e;
    }
    footer p {
      margin: 0.5rem 0;
    }
    .social-icons a {
      margin: 0 10px;
      color: #666;
      font-size: 1.2rem;
      transition: color 0.3s;
    }
    .dark-mode .social-icons a {
      color: #f49ac1;
    }
    @media (min-width: 768px) {
      .user-info {
        flex-direction: row;
        justify-content: flex-start;
        text-align: right;
        gap: 2rem;
      }
      .user-info .avatar {
        margin-bottom: 0;
      }
    }
  </style>
</head>
<body>
  <!-- ✅ الشريط العلوي والبحث -->
  <div class="mobile-search-slide" id="searchSlide">
    <form id="mobile-search-form">
      <input type="text" id="mobile-search-input" placeholder="ابحث عن منتج...">
      <button type="submit"><i class="fas fa-search"></i></button>
      <span class="close-slide" id="closeSearch">&times;</span>
    </form>
  </div>

  <nav>
    <div class="logo">
      <img src="images/logo.png" alt="Dandy Logo" />
    </div>
    <ul>
      <li><a href="index.html">الرئيسية</a></li>
      <li><a href="all-products.html">المنتجات</a></li>
      <li><a href="#contact">تواصل معنا</a></li>
    </ul>
    <form id="search-form" class="desktop-search search-bar">
      <input type="text" id="search-input" placeholder="ابحث عن منتج...">
      <button type="submit"><i class="fas fa-search"></i></button>
    </form>
    <button class="mobile-search-icon"><i class="fas fa-search"></i></button>
  </nav>

  <div class="profile-box">
    <div class="user-card">
      <div class="avatar"><i class="fas fa-user"></i></div>
      <div class="user-details">
        <h2 id="user-name">...</h2>
        <p id="user-email"></p>
        <p>آخر تسجيل دخول: <span id="last-login"></span></p>
      </div>
    </div>

    <div class="section">
      <h3>منتجات مقترحة لك</h3>
      <div class="cards-container" id="suggestions">
        <div>جاري التحميل...</div>
      </div>
    </div>

    <button class="logout-btn" onclick="logout()">تسجيل الخروج</button>
  </div>

  <footer id="contact">
    <p>© 2025 Dandy. جميع الحقوق محفوظة.</p>
    <div class="social-icons">
      <a href="https://www.facebook.com/profile.php?id=61563039704396"><i class="fab fa-facebook"></i></a>
      <a href="https://www.instagram.com/dandy_skincare_cosmotics"><i class="fab fa-instagram"></i></a>
      <a href="#"><i class="fab fa-whatsapp"></i></a>
    </div>
  </footer>
  <button id="theme-toggle" aria-label="Toggle dark mode">
    <i class="fas fa-moon"></i>
  </button>

  <!-- Firebase & Scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDqYY4EF0Nig9aBOxmWZJA8D-4Gr4tT-UU",
      authDomain: "dandy-562fc.firebaseapp.com",
      databaseURL: "https://dandy-562fc-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "dandy-562fc",
      storageBucket: "dandy-562fc.appspot.com",
      messagingSenderId: "454972972842",
      appId: "1:454972972842:web:fedc5e92e258a06ca08853"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    const nameSpan = document.getElementById("user-name");
    const emailDisplay = document.getElementById("user-email");
    const loginDisplay = document.getElementById("last-login");
    const suggestionsList = document.getElementById("suggestions");

    auth.onAuthStateChanged(user => {
      if (user) {
        const uid = user.uid;
        db.ref("users/" + uid).once("value", snapshot => {
          const userData = snapshot.val();
          nameSpan.textContent = userData?.name || user.displayName || "بدون اسم";
        });
        emailDisplay.textContent = `البريد الإلكتروني: ${user.email}`;
        loginDisplay.textContent = new Date(user.metadata.lastSignInTime).toLocaleString('ar-EG');
        loadDailySuggestions(uid);
      } else {
        window.location.href = "login.html";
      }
    });

    function loadDailySuggestions(uid) {
      const todayKey = new Date().toISOString().split('T')[0];
      db.ref(`users/${uid}/dailySuggestions/${todayKey}`).once("value", snap => {
        if (snap.exists()) {
          renderSuggestions(snap.val());
        } else {
          db.ref("products").once("value", snapshot => {
            const allProducts = [];
            snapshot.forEach(child => {
              allProducts.push({
                name: child.val().name,
                image: child.val().image,
                id: child.key
              });
            });
            const randomThree = allProducts.sort(() => 0.5 - Math.random()).slice(0, 3);
            db.ref(`users/${uid}/dailySuggestions/${todayKey}`).set(randomThree);
            renderSuggestions(randomThree);
          });
        }
      });
    }

    function renderSuggestions(products) {
      suggestionsList.innerHTML = "";
      products.forEach(p => {
        const card = document.createElement("div");
        card.className = "product-card";
        card.innerHTML = `
          <img src="${p.image}" alt="${p.name}">
          <h4>${p.name}</h4>
          <a href="product.html?id=${p.id}">عرض المنتج</a>
        `;
        suggestionsList.appendChild(card);
      });
    }

    function logout() {
      auth.signOut().then(() => {
        window.location.href = "login.html";
      });
    }

    // 🌙 زر الوضع الليلي
    const toggleBtn = document.getElementById("theme-toggle");
    const icon = toggleBtn.querySelector("i");
    const savedTheme = localStorage.getItem("theme");
    if (savedTheme === "dark") {
      document.body.classList.add("dark-mode");
      icon.classList.replace("fa-moon", "fa-sun");
    }
    toggleBtn.addEventListener("click", () => {
      document.body.classList.toggle("dark-mode");
      const isDark = document.body.classList.contains("dark-mode");
      icon.classList.toggle("fa-moon", !isDark);
      icon.classList.toggle("fa-sun", isDark);
      localStorage.setItem("theme", isDark ? "dark" : "light");
    });

    // 🔍 البحث
    const searchForm = document.getElementById("search-form");
    if (searchForm) {
      searchForm.addEventListener("submit", function(e) {
        e.preventDefault();
        const query = document.getElementById("search-input").value.trim();
        if (query) {
          window.location.href = `all-products.html?search=${encodeURIComponent(query)}`;
        }
      });
    }

    const searchSlide = document.getElementById("searchSlide");
    const openBtn = document.querySelector(".mobile-search-icon");
    const closeBtn = document.getElementById("closeSearch");

    if (openBtn && searchSlide && closeBtn) {
      openBtn.addEventListener("click", () => {
        searchSlide.classList.add("active");
        document.getElementById("mobile-search-input").focus();
      });

      closeBtn.addEventListener("click", () => {
        searchSlide.classList.remove("active");
      });

      document.getElementById("mobile-search-form").addEventListener("submit", function(e) {
        e.preventDefault();
        const query = document.getElementById("mobile-search-input").value.trim();
        if (query) {
          window.location.href = `all-products.html?search=${encodeURIComponent(query)}`;
        }
      });

      document.addEventListener("click", function (e) {
        const isSearchOpen = searchSlide.classList.contains("active");
        const clickedInside = searchSlide.contains(e.target) || e.target.classList.contains("mobile-search-icon") || e.target.closest(".mobile-search-icon");
        if (isSearchOpen && !clickedInside) {
          searchSlide.classList.remove("active");
        }
      });
    }
  </script>
</body>
</html>
