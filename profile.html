<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ملفي الشخصي - Dandy</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="style.css">
  <style>

    html, body {
  height: 100%;
  margin: 0;
  display: flex;
  flex-direction: column;
}

body {
  font-family: 'Tajawal', sans-serif;
}

.profile-box {
  flex: 1; /* هذا يجعل المحتوى يتمدد ويترك الفوتر في الأسفل */
}


    body.dark-mode {
      background-color: #121212;
      color: #f49ac1;
    }
    .profile-box {
      background: white;
      padding: 1rem;
      border-radius: 20px;
      max-width: 900px;
      margin: 2rem auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .user-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      background-color: #fff0f6;
      border-radius: 15px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      text-align: center;
    }
    .user-card .avatar {
      width: 90px;
      height: 90px;
      background-color: #f49ac1;
      color: white;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 2.5rem;
    }
    .user-details h2 {
      margin: 0;
      color: var(--accent-color);
      font-size: 1.6rem;
    }
    .user-details p {
      margin: 0.3rem 0;
      color: var(--text-color);
      font-size: 0.95rem;
    }
    .section {
      margin-top: 2rem;
    }
    .section h3 {
      color: var(--accent-color);
      margin-bottom: 1rem;
      font-size: 1.4rem;
      text-align: center;
    }
    .cards-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
    }
    .product-card {
      background: #fff0f6;
      border-radius: 15px;
      padding: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      text-align: center;
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .product-card img {
      width: 100%;
      height: 160px;
      object-fit: cover;
      border-radius: 12px;
      margin-bottom: 0.75rem;
    }
    .product-card h4 {
      margin: 0.5rem 0;
      font-size: 1rem;
      color: var(--text-color);
    }
    .product-card a {
      display: inline-block;
      margin-top: 0.5rem;
      padding: 0.4rem 1rem;
      background-color: var(--accent-color);
      color: white;
      text-decoration: none;
      border-radius: 20px;
      font-size: 0.9rem;
      transition: background 0.3s;
    }
    .product-card a:hover {
      background-color: #e07aa2;
    }
    .logout-btn {
      margin-top: 2rem;
      background-color: #f49ac1;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 12px;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.3s;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    .logout-btn:hover {
      background-color: #e07aa2;
    }
    @media (min-width: 600px) {
      .user-card {
        flex-direction: row;
        text-align: start;
      }
      .user-details {
        text-align: start;
      }
    }

    /* ✅ إظهار الزر في الموبايل فقط */
@media (max-width: 768px) {
  .desktop-search {
    display: none !important;
  }
  .mobile-search-icon {
    display: inline-block;
  }
}

/* زر الهمبرجر */
.hamburger-icon {
  display: none;
  background: none;
  border: none;
  font-size: 22px;
  color: #f49ac1;
  cursor: pointer;
}

@media (max-width: 768px) {
  .hamburger-icon {
    display: inline-block;
    margin-right: 10px;
  }

  nav ul {
    display: none; /* إخفاء القائمة العادية في الموبايل */
  }
}

/* قائمة الموبايل الجانبية */
.mobile-menu {
  position: fixed;
  top: 0;
  right: -100%;
  width: 250px;
  height: 100%;
  background-color: #fff;
  box-shadow: -2px 0 12px rgba(0, 0, 0, 0.1);
  z-index: 9999;
  transition: right 0.3s ease;
  padding-top: 4rem;
}

.mobile-menu ul {
  list-style: none;
  padding: 0;
  margin: 0;
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
  padding: 1rem;
}

.mobile-menu ul li a {
  text-decoration: none;
  color: var(--text-color);
  font-size: 1.1rem;
  transition: color 0.3s;
}

.mobile-menu ul li a:hover {
  color: var(--accent-color);
}

.mobile-menu.active {
  right: 0;
}

/* الوضع الليلي للقائمة الجانبية */
body.dark-mode .mobile-menu {
  background-color: #1e1e1e;
}

body.dark-mode .mobile-menu ul li a {
  color: #f49ac1;
}
  </style>
</head>
<body>
  <!-- ✅ الشريط العلوي والبحث -->
  <div class="mobile-search-slide" id="searchSlide">
    <form id="mobile-search-form">
      <input type="text" id="mobile-search-input" placeholder="ابحث عن منتج...">
      <button type="submit"><i class="fas fa-search"></i></button>
      <span class="close-slide" id="closeSearch">&times;</span>
    </form>
  </div>

  <!-- Navigation -->
  <nav>
    <!-- قائمة الموبايل الجانبية -->
<div class="mobile-menu" id="mobileMenu">
  <ul>
    <li><a href="index.html">الرئيسية</a></li>
    <li><a href="all-products.html">المنتجات</a></li>
    <li><a href="#">الملف الشخصي</a></li>
    <li><a href="#contact">تواصل معنا</a></li>
  </ul>
</div>

    <div class="logo">
  <img src="images/logo.png" alt="Dandy Logo" />
</div>
    <!-- زر القائمة الجانبية للموبايل -->
<button class="hamburger-icon" id="hamburgerBtn">
  <i class="fas fa-bars"></i>
</button>

    <ul>
      <li><a href="index.html">الرئيسية</a></li>
      <li><a href="#">المنتجات</a></li>
      <li><a href="profile.html">الملف الشخصي</a></li>
      <li><a href="#contact">تواصل معنا</a></li>
    </ul>
    <!-- ✅ شريط البحث للكمبيوتر -->
    <form id="search-form" class="desktop-search search-bar">
      <input type="text" id="search-input" placeholder="ابحث عن منتج...">
      <button type="submit"><i class="fas fa-search"></i></button>
    </form>

    <!-- ✅ زر العدسة للموبايل -->
    <button class="mobile-search-icon"><i class="fas fa-search"></i></button>
  </nav>

  <div class="profile-box">
    <div class="user-card">
      <div class="avatar"><i class="fas fa-user"></i></div>
      <div class="user-details">
        <h2 id="user-name">...</h2>
        <p id="user-email"></p>
        <p>آخر تسجيل دخول: <span id="last-login"></span></p>
      </div>
    </div>

    <div class="section">
      <h3>منتجات مقترحة لك</h3>
      <div class="cards-container" id="suggestions">
        <div>جاري التحميل...</div>
      </div>
    </div>

    <button class="logout-btn" onclick="logout()">تسجيل الخروج</button>
  </div>

  <footer id="contact">
    <p>© 2025 Dandy. جميع الحقوق محفوظة.</p>
    <div class="social-icons">
      <a href="https://www.facebook.com/profile.php?id=61563039704396"><i class="fab fa-facebook"></i></a>
      <a href="https://www.instagram.com/dandy_skincare_cosmotics"><i class="fab fa-instagram"></i></a>
      <a href="#"><i class="fab fa-whatsapp"></i></a>
    </div>
  </footer>
  <button id="theme-toggle" aria-label="Toggle dark mode">
    <i class="fas fa-moon"></i>
  </button>

  <!-- Firebase & Scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDqYY4EF0Nig9aBOxmWZJA8D-4Gr4tT-UU",
      authDomain: "dandy-562fc.firebaseapp.com",
      databaseURL: "https://dandy-562fc-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "dandy-562fc",
      storageBucket: "dandy-562fc.appspot.com",
      messagingSenderId: "454972972842",
      appId: "1:454972972842:web:fedc5e92e258a06ca08853"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    const nameSpan = document.getElementById("user-name");
    const emailDisplay = document.getElementById("user-email");
    const loginDisplay = document.getElementById("last-login");
    const suggestionsList = document.getElementById("suggestions");

    auth.onAuthStateChanged(user => {
      if (user) {
        const uid = user.uid;
        db.ref("users/" + uid).once("value", snapshot => {
          const userData = snapshot.val();
          nameSpan.textContent = userData?.name || user.displayName || "بدون اسم";
        });
        emailDisplay.textContent = `البريد الإلكتروني: ${user.email}`;
        loginDisplay.textContent = new Date(user.metadata.lastSignInTime).toLocaleString('ar-EG');
        loadDailySuggestions(uid);
      } else {
        window.location.href = "login.html";
      }
    });

    function loadDailySuggestions(uid) {
      const todayKey = new Date().toISOString().split('T')[0];
      db.ref(`users/${uid}/dailySuggestions/${todayKey}`).once("value", snap => {
        if (snap.exists()) {
          renderSuggestions(snap.val());
        } else {
          db.ref("products").once("value", snapshot => {
            const allProducts = [];
            snapshot.forEach(child => {
              allProducts.push({
                name: child.val().name,
                image: child.val().image,
                id: child.key
              });
            });
            const randomThree = allProducts.sort(() => 0.5 - Math.random()).slice(0, 3);
            db.ref(`users/${uid}/dailySuggestions/${todayKey}`).set(randomThree);
            renderSuggestions(randomThree);
          });
        }
      });
    }

    function renderSuggestions(products) {
      suggestionsList.innerHTML = "";
      products.forEach(p => {
        const card = document.createElement("div");
        card.className = "product-card";
        card.innerHTML = `
          <img src="${p.image}" alt="${p.name}">
          <h4>${p.name}</h4>
          <a href="product.html?id=${p.id}">عرض المنتج</a>
        `;
        suggestionsList.appendChild(card);
      });
    }

    function logout() {
      auth.signOut().then(() => {
        window.location.href = "login.html";
      });
    }

    // 🌙 زر الوضع الليلي
    const toggleBtn = document.getElementById("theme-toggle");
    const icon = toggleBtn.querySelector("i");
    const savedTheme = localStorage.getItem("theme");
    if (savedTheme === "dark") {
      document.body.classList.add("dark-mode");
      icon.classList.replace("fa-moon", "fa-sun");
    }
    toggleBtn.addEventListener("click", () => {
      document.body.classList.toggle("dark-mode");
      const isDark = document.body.classList.contains("dark-mode");
      icon.classList.toggle("fa-moon", !isDark);
      icon.classList.toggle("fa-sun", isDark);
      localStorage.setItem("theme", isDark ? "dark" : "light");
    });

    // 🔍 البحث
    const searchForm = document.getElementById("search-form");
    if (searchForm) {
      searchForm.addEventListener("submit", function(e) {
        e.preventDefault();
        const query = document.getElementById("search-input").value.trim();
        if (query) {
          window.location.href = `all-products.html?search=${encodeURIComponent(query)}`;
        }
      });
    }

    const searchSlide = document.getElementById("searchSlide");
    const openBtn = document.querySelector(".mobile-search-icon");
    const closeBtn = document.getElementById("closeSearch");

    if (openBtn && searchSlide && closeBtn) {
      openBtn.addEventListener("click", () => {
        searchSlide.classList.add("active");
        document.getElementById("mobile-search-input").focus();
      });

      closeBtn.addEventListener("click", () => {
        searchSlide.classList.remove("active");
      });

      document.getElementById("mobile-search-form").addEventListener("submit", function(e) {
        e.preventDefault();
        const query = document.getElementById("mobile-search-input").value.trim();
        if (query) {
          window.location.href = `all-products.html?search=${encodeURIComponent(query)}`;
        }
      });

      document.addEventListener("click", function (e) {
        const isSearchOpen = searchSlide.classList.contains("active");
        const clickedInside = searchSlide.contains(e.target) || e.target.classList.contains("mobile-search-icon") || e.target.closest(".mobile-search-icon");
        if (isSearchOpen && !clickedInside) {
          searchSlide.classList.remove("active");
        }
      });
    }
  </script>

<!-- زر فتح الدردشة -->
<button id="chat-toggle" style="position: fixed; bottom: 20px; right: 20px; background: #f49ac1; color: white; border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 1.3rem; z-index: 10000;">
  <i class="fas fa-comment"></i>
</button>

<!-- نافذة الدردشة -->
<div id="chat-box" class="chat-box hidden">
  <span id="close-chat" class="close-chat">&times;</span>
  <h4>تواصل معنا</h4>
  <input type="text" id="chat-name" placeholder="الاسم" required>
  <input type="text" id="chat-phone" placeholder="رقم الهاتف" required>
  <textarea id="chat-message" placeholder="رسالتك" rows="3" required></textarea>
  <button onclick="sendChatMessage()">إرسال</button>
  <div id="chat-response"></div>
</div>


<style>
.chat-box {
  position: fixed;
  bottom: 90px;
  right: 20px;
  width: 300px;
  background: white;
  border: 2px solid #f49ac1;
  border-radius: 15px;
  padding: 1rem;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
  z-index: 9999;
  transition: all 0.3s;
  font-family: 'Tajawal', sans-serif;
}

.chat-box.hidden {
  display: none;
}

.chat-box h4 {
  margin: 0 0 1rem;
  color: #f49ac1;
  font-size: 1.2rem;
  text-align: center;
}

.chat-box input,
.chat-box textarea {
  width: 100%;
  padding: 8px;
  margin-bottom: 0.75rem;
  border: 1px solid #ccc;
  border-radius: 8px;
  font-family: inherit;
  font-size: 0.95rem;
  box-sizing: border-box;
}

.chat-box button {
  background-color: #f49ac1;
  color: white;
  border: none;
  padding: 10px;
  width: 100%;
  border-radius: 10px;
  cursor: pointer;
  font-size: 1rem;
  transition: background 0.3s;
}

.chat-box button:hover {
  background-color: #e07aa2;
}

#chat-response {
  background-color: #fef0f5;
  padding: 0.6rem;
  border-radius: 10px;
  font-size: 0.9rem;
  margin-top: 1rem;
  border: 1px solid #f49ac1;
}

.close-chat {
  position: absolute;
  top: 10px;
  left: 15px;
  font-size: 1.2rem;
  color: #888;
  cursor: pointer;
}
</style>

<script>
  // فتح وغلق نافذة الدردشة
  document.getElementById("chat-toggle").addEventListener("click", () => {
    const chatBox = document.getElementById("chat-box");
    chatBox.classList.toggle("hidden");

    // لو رقم الهاتف مكتوب، اعرض الرد تلقائيًا
    const phone = document.getElementById("chat-phone").value.trim();
    if (phone) {
      checkForReply(phone);
    }
  });

  document.getElementById("close-chat").addEventListener("click", () => {
    document.getElementById("chat-box").classList.add("hidden");
  });

  // ✅ التحقق من وجود رد بناءً على رقم الهاتف
  function checkForReply(phone) {
    const chatResponse = document.getElementById("chat-response");

    db.ref("chatMessages").orderByChild("phone").equalTo(phone).once("value", snapshot => {
      if (snapshot.exists()) {
        const messages = Object.values(snapshot.val());

        // ترتيب الرسائل حسب الوقت من الأحدث للأقدم
        messages.sort((a, b) => b.timestamp - a.timestamp);

        // نبحث عن أحدث رسالة تحتوي على رد
        const lastWithReply = messages.find(m => m.reply);

        if (lastWithReply) {
          chatResponse.innerHTML = `
            <strong>ردنا عليك:</strong><br>
            ${lastWithReply.reply}<br>
            <small>📩 بتاريخ: ${new Date(lastWithReply.repliedAt).toLocaleString('ar-EG')}</small>
          `;
        } else {
          chatResponse.innerHTML = `⏳ تم استلام رسالتك، نعمل على الرد قريبًا.`;
        }
      } else {
        chatResponse.innerHTML = "🔍 لم يتم العثور على رسالة مرتبطة بهذا الرقم.";
      }
    });
  }

  // ✅ إرسال الرسالة إلى Firebase
  function sendChatMessage() {
    const name = document.getElementById("chat-name").value.trim();
    const phone = document.getElementById("chat-phone").value.trim();
    const message = document.getElementById("chat-message").value.trim();

    if (!name || !phone || !message) {
      alert("يرجى ملء جميع الحقول");
      return;
    }

    const chatRef = db.ref("chatMessages").push();
    chatRef.set({
      name,
      phone,
      message,
      timestamp: Date.now()
    }).then(() => {
      alert("✅ تم إرسال رسالتك بنجاح");

      // تفريغ الحقول
      document.getElementById("chat-name").value = "";
      document.getElementById("chat-phone").value = "";
      document.getElementById("chat-message").value = "";

      // عرض الرد (لو فيه)
      checkForReply(phone);

      // إغلاق النافذة بعد 5 ثواني
      setTimeout(() => {
        document.getElementById("chat-box").classList.add("hidden");
      }, 5000);

    }).catch((error) => {
      console.error("❌ فشل الإرسال", error);
      alert("حدث خطأ أثناء الإرسال، حاول مرة أخرى.");
    });
  }
</script>

  <script>
  const hamburgerBtn = document.getElementById("hamburgerBtn");
  const mobileMenu = document.getElementById("mobileMenu");

  hamburgerBtn.addEventListener("click", () => {
    mobileMenu.classList.toggle("active");
  });

  // إغلاق القائمة عند الضغط خارجها
  document.addEventListener("click", function (e) {
    if (
      !mobileMenu.contains(e.target) &&
      !hamburgerBtn.contains(e.target)
    ) {
      mobileMenu.classList.remove("active");
    }
  });
</script>

</body>
</html>
